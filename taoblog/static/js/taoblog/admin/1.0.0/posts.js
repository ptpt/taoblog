(function(){var t={}.hasOwnProperty,e=function(e,n){function r(){this.constructor=e}for(var o in n)t.call(n,o)&&(e[o]=n[o]);return r.prototype=n.prototype,e.prototype=new r,e.__super__=n.prototype,e};define("taoblog/admin/1.0.0/posts",["$","Uri","./browser","./toolbar","./dom","./utils"],function(t){var n,r,o,s,i,u,a,l,c,d,h,p,f,m;return n=t("$"),d=t("Uri"),r=t("./browser"),c=t("./toolbar"),p=t("./dom"),h=t("./utils"),u=0,s=1,l=2,i="/static/img/eye-blocked.png",o="/static/img/pencil3.png",a=function(t){function r(){return m=r.__super__.constructor.apply(this,arguments)}return e(r,t),r.prototype.showDate=function(t){var e;return e=new Date,n(this.items).find("TD.date > time").each(function(){var e;return e=new Date(n(this).attr("datetime")),n(this).text(t(e))})},r.prototype.makePostItem=function(t){var e,n;return e=t.draft?["img",{"class":"draft",src:o}]:null,n=t.status===s?["img",{"class":"private",src:i}]:null,p(["tr",{"class":"item","data-id":t.id,"data-status":t.status},["td",{"class":"title"},h.truncate(t.title,64),e,n],["td",{"class":"tags"},t.tags.join(",")],["td",{"class":"date"},["time",{datetime:t.created_at+"Z"},h.getTimeAgo(new Date(t.created_at))]]])},r.prototype.setPosts=function(t){var e,n,r;for(this.tbody.empty(),n=0,r=t.length;r>n;n++)e=t[n],this.tbody.append(this.makePostItem(e));return this.reload()},r.prototype.appendPosts=function(t){var e,n,r;for(n=0,r=t.length;r>n;n++)e=t[n],this.tbody.append(this.makePostItem(e));return this.reload()},r.prototype.removeSelections=function(t){var e,r,o;return o=0,r=this.getSelections().length,e=this,this.getSelections().fadeOut("fast",function(){return n(this).remove(),o++,o>=r?(e.reload(),"function"==typeof t?t():void 0):void 0})},r.prototype.removeAll=function(t){var e,r,o;return o=0,r=this.items.length,e=this,this.items.fadeOut("fast",function(){return n(this).remove(),o++,o>=r?(e.reload(),"function"==typeof t?t():void 0):void 0})},r.prototype.markSelectedPostsAs=function(t){var e,r,o,a,c,d;for(o=this.getSelections(),"private"===t?o.data("status",s):"public"===t?o.data("status",u):"trash"===t&&o.data("status",l),d=[],a=0,c=o.length;c>a;a++)r=o[a],e=n(r).find("TD.title > IMG.private"),"private"===t?0===e.length?d.push(n(r).children("TD.title").append(p(["img",{"class":"private",src:i}]))):d.push(void 0):"public"===t?e.length>0?d.push(e.remove()):d.push(void 0):d.push(void 0);return d},r.prototype.countSelectionsByStatus=function(){var t,e,r,o,i,a,c;for(r=[],e=[],o=[],c=this.getSelections(),i=0,a=c.length;a>i;i++)t=c[i],n(t).data("status")===u?r.push(t):n(t).data("status")===s?e.push(t):n(t).data("status")===l&&o.push(t);return[r,e,o]},r}(r),f=function(){var t,e,r,o,s,i,u,l;return l=new c("#toolbar"),t=new a("TABLE.browser"),s=function(e,r,o){var s;return null==o&&(o=n(t.selector).data("status")),s=new d(window.location.href),null!=e&&s.addQueryParam("offset",encodeURIComponent(e)),null!=r&&s.addQueryParam("limit",encodeURIComponent(r)),null!=o&&s.addQueryParam("status",encodeURIComponent(o)),s.addQueryParam("meta",!0),"/api/posts/"+s.query()},e=function(){return n.ajax({url:"/api/posts/?status=trash",type:"DELETE",success:function(e){return t.removeAll(function(){return h.flash(""+e.response.total_posts+" "+(1===e.response.total_posts?"post":"posts")+" got deleted")})},error:function(){return u(),h.flash("failed to clear trash","error")}})},r=function(e){var r,o;return r=t.getSelections().length,o=t.items.length-r,n.get(s(o,r,e),function(e){return t.removeSelections(function(){return u(),t.appendPosts(e.response.posts),e.response.more?void 0:n("#more-posts").hide()})}).error(function(){return t.clearSelections(),u(),h.flash("failed to get new posts","error")})},o=function(e){var o,s;return s=t.getSelections(),n.ajax({url:"/api/posts/?bulk="+encodeURIComponent(function(){var e,r,s,i;for(s=t.getSelections(),i=[],e=0,r=s.length;r>e;e++)o=s[e],i.push(n(o).data("id"));return i}().join(",")),type:"DELETE",success:function(){return h.flash(""+s.length+" "+(1===s.length?"post":"posts")+" has been deleted"),r(e)},error:function(){return t.clearSelections(),u(),h.flash("failed to delete selected posts","error")}})},i=function(e,o){var s,i,a,l;return l=t.getSelections(),l.length?("public"===o?(s="publish",a="published"):"private"===o?(s="hide",a="hidden"):"trash"===o&&(s="trash",a="trashed"),n.post("/api/posts/"+s,{id:function(){var t,e,r;for(r=[],t=0,e=l.length;e>t;t++)i=l[t],r.push(n(i).data("id"));return r}().join(",")},function(){return"trash"===e||"trash"===o?(h.flash(""+l.length+" "+(1===l.length?"post":"posts")+" has been "+a),r(e)):(h.flash(""+l.length+" "+(1===l.length?"post":"posts")+" has been "+a),t.markSelectedPostsAs(o),u())}).error(function(){return t.clearSelections(),h.flash("failed to #{ action } selected posts","error")})):void 0},t.bind("click",function(){return u()}),t.bind("dblclick",function(){return window.location="/post/"+n(this).data("id")+"/edit"}),u=function(){var e,r,o,s,i,u;return e=n(t.selector).data("status"),l.hideAllMenus(),l.showMenu("new-post"),u=function(){var e,n,o,s;for(o=t.countSelectionsByStatus(),s=[],e=0,n=o.length;n>e;e++)r=o[e],s.push(r.length);return s}(),s=u[0],o=u[1],i=u[2],1===s+o?l.showMenu("edit"):l.hideMenu("edit"),s>0||o>0?l.showMenu("trash"):l.hideMenu("trash"),s>0||i>0?l.showMenu("hide"):l.hideMenu("hide"),o>0||i>0?l.showMenu("publish"):l.hideMenu("publish"),i>0?(l.showMenu("delete"),l.hideMenu("delete-all")):(l.hideMenu("delete"),"trash"===e?l.showMenu("delete-all"):void 0)},n("html").click(function(e){return 0===t.items.find(e.target).length&&0===n(l.selector).find(e.target).length?(t.clearSelections(),u()):void 0}),n("#more-posts").click(function(e){var r,o;return e.preventDefault(),r=t.items.length,o=s(r),n.get(o,function(e){return t.appendPosts(e.response.posts),e.response.more?void 0:n("#more-posts").hide()}).error(function(){return h.flash("failed to get new posts","error")})}),function(){var r,s;return r=n(t.selector).data("status"),l.addMenu("new-post",["li",["a",{href:"/admin/compose"},"New Post"]]),s=l.addMenu("edit",["li",["a",{href:"#"},"Edit"]]),l.hideMenu("edit"),n("a",s).click(function(e){var r;return e.preventDefault(),r=n(t.getSelections()).data("id"),window.location="/post/"+r+"/edit"}),s=l.addMenu("delete-all",["li",["a",{href:"#"},"Delete All"]]),l.hideMenu("delete-all"),n("a",s).click(function(t){return t.preventDefault(),e()}),s=l.addMenu("delete",["li",["a",{href:"#"},"Delete"]]),l.hideMenu("delete"),n("a",s).click(function(t){return t.preventDefault(),o(r)}),s=l.addMenu("trash",["li",["a",{href:"#","data-action":"/api/posts/trash"},"Trash"]]),l.hideMenu("trash"),n("a",s).click(function(t){return t.preventDefault(),i(r,"trash")}),s=l.addMenu("hide",["li",["a",{href:"#","data-action":"/api/posts/hide"},"Hide"]]),l.hideMenu("hide"),n("a",s).click(function(t){return t.preventDefault(),i(r,"private")}),s=l.addMenu("publish",["li",["a",{href:"#","data-action":"/api/posts/publish"},"Publish"]]),l.hideMenu("publish"),n("a",s).click(function(t){return t.preventDefault(),i(r,"public")}),u(),t.showDate(h.getTimeAgo)}()}})}).call(this),function(){define("taoblog/admin/1.0.0/browser",["$"],function(t){var e,n;return e=t("$"),n=function(){function t(t){var n;n=this,this.selectedClass="selected",this.tbody=e(t).children("TBODY"),this.items=this.tbody.children("TR.item"),this.lastSelectedRow=0,this.selector=t,this.events=[],this.bind("click",function(t,e){var r,o,s;if(t.shiftKey)for(r=o=e,s=n.lastSelectedRow;s>=e?s>=o:o>=s;r=s>=e?++o:--o)n.select(r);else t.ctrlKey?n.toggleSelection(e):(n.clearSelections(),n.select(e));return n.lastSelectedRow=e})}return t.prototype.select=function(t){return this.isSelected(t)?void 0:this.items.eq(t).addClass(this.selectedClass)},t.prototype.unselect=function(t){return this.isSelected(t)?this.items.eq(t).removeClass(this.selectedClass):void 0},t.prototype.clearSelections=function(){var t,e,n,r;for(r=[],t=e=0,n=this.items.length;n>=0?n>=e:e>=n;t=n>=0?++e:--e)r.push(this.unselect(t));return r},t.prototype.isSelected=function(t){return this.items.eq(t).hasClass(this.selectedClass)},t.prototype.toggleSelection=function(t){return this.isSelected(t)?this.unselect(t):this.select(t)},t.prototype.getSelections=function(){return this.items.filter("."+this.selectedClass)},t.prototype.selectAll=function(){return this.items.addClass(selectedClass)},t.prototype.bind=function(t,n){return this.events.push({type:t,handler:n}),this.items.each(function(r){return e(this).bind(t,function(t){return n.apply(this,[t,r])})})},t.prototype.rebind=function(){var t,e,n,r,o;for(e=this.events,this.events=[],o=[],n=0,r=e.length;r>n;n++)t=e[n],o.push(this.bind(t.type,t.handler));return o},t.prototype.reload=function(){return this.items=this.tbody.children("TR.item"),this.lastSelectedRow=0,this.items.unbind(),this.rebind()},t}()})}.call(this),function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};define("taoblog/admin/1.0.0/toolbar",["$","./dom"],function(e){var n,r,o;return n=e("$"),o=e("./dom"),r=function(){function e(e){this.addMenu=t(this.addMenu,this),this.selector=e,this.menus={}}return e.prototype.addMenu=function(t,e){var r;return t in this.menus?r=this.menus[t]:(r=o(e),this.menus[t]=r,n(this.selector).append(r)),r},e.prototype.removeAll=function(){return n(this.selector).remove()},e.prototype.removeMenu=function(t){return n(this.menus[t]).remove(),delete this.menus[t]},e.prototype.hideMenu=function(t){return n(this.menus[t]).hide()},e.prototype.showMenu=function(t){return n(this.menus[t]).show()},e.prototype.hideAllMenus=function(){var t,e,r,o;r=this.menus,o=[];for(t in r)e=r[t],o.push(n(e).hide());return o},e.prototype.showAllMenus=function(){var t,e,r,o;r=this.menus,o=[];for(t in r)e=r[t],o.push(n(e).show());return o},e.prototype.empty=function(){return n(this.selector).empty(),this.menus={}},e}()})}.call(this),function(){define("taoblog/admin/1.0.0/dom",[],function(){var t;return t=function(e){var n,r,o,s,i,u,a,l;if(0===e.length)return null;for(r=e[0]instanceof HTMLElement?e[0]:document.createElement(e[0]),l=e.slice(1),u=0,a=l.length;a>u;u++)if(s=l[u],"[object String]"===toString.call(s))r.appendChild(document.createTextNode(s));else if(s instanceof Text)r.appendChild(s);else if(Array.isArray(s))n=t(s),null!=n&&r.appendChild(n);else if(s instanceof Attr)r.setAttributeNode(s);else if(s===Object(s))for(o in s)i=s[o],r.setAttribute(o,i);return r}})}.call(this),function(){define("taoblog/admin/1.0.0/utils",["$","./dom"],function(t){var e,n,r,o,s;return e=t("$"),n=t("./dom"),o=function(t){var e,n,r,o,s;return o=new Date,s=Math.floor((o-t)/1e3),0===s?"just now":(r=Math.floor(s/60),0===r?""+s+" "+(1===s?"second":"seconds")+" ago":(n=Math.floor(r/60),0===n?""+r+" "+(1===r?"minute":"minutes")+" ago":(e=Math.floor(n/24),0===e?""+n+" "+(1===n?"hour":"hours")+" ago":e>30?t.toDateString():""+e+" "+(1===e?"day":"days")+" ago")))},s=function(t,e,n,r){var o,s,i,u,a;if(null==e&&(e=255),null==n&&(n=!1),null==r&&(r="..."),console.log(t),e>=t.length)return t;if(n)return t.slice(0,+(e-1)+1||9e9)+r;for(o=i=e,u=e/2;u>=e?u>=i:i>=u;o=u>=e?++i:--i)if("\n"===(a=t[o])||"	"===a||" "===a)s=!0;else if(s)return t.slice(0,+(o-1)+1||9e9)+r;return t.slice(0,+(o-1)+1||9e9)+r},r=function(t,r){var o;return null==r&&(r="success"),o=n(["p",{"class":r},t]),e("#flash").append(o),e(o).hide(),e(o).fadeIn("fast").delay("success"===r?3e3:6e3).fadeOut("slow",function(){return e(this).remove()})},{getTimeAgo:o,truncate:s,flash:r}})}.call(this);
